## 康复外骨骼控制程序 / 项目总览

本项目用于开发 **康复外甲（外骨骼）控制程序**，包括主控与电机的通讯、关节运动控制、以及康复训练策略实现。

- **项目目标**：
  - 搭建稳定可靠的主控与电机 CAN 通讯。✅ **已完成**
  - 完成髋踝等关节的基础调试与联动控制。🔄 **进行中**
  - 实现分阶段的康复训练模式（早期被动模式、主动康复模式）。📋 **规划中**
  - 开发柔和的辅助控制策略，支持患者主动性训练。📋 **规划中**

- **当前阶段**：基础通讯已完成，进入控制策略开发
  - ✅ 已完成：CAN 协议实现、电机使能/掉电、多圈角度读取、位置控制、串口交互
  - 🔄 进行中：髋踝联动基础测试、位置控制精度调试
  - 📋 下一步：实现早期被动模式（标准步态引导）

---

## 仓库结构

- `参考资料/`：硬件及协议相关文档
  - `电机CAN协议说明 V2.35.pdf`：电机 CAN 通讯协议
  - `电机 CAN 总线通讯协议（V2.35）整理.md`：协议整理文档
  - `髋踝联动调试方案V2.md`：康复训练控制策略
- `firmware/`：下位机固件（Teensy 4.1）
  - `firmware/src/main.cpp`：主控程序（CAN 通讯、电机控制、串口交互）
  - `firmware/platformio.ini`：PlatformIO 配置文件
- `docs/`：项目文档与调试记录
  - `docs/项目概览.md`：系统架构、软硬件接口一览
  - `docs/调试记录-主控与电机CAN.md`：调试过程记录
  - `docs/规范-电机CAN与髋踝联动.md`：关键软件/协议规范

---

## 使用建议

1. **每次调试前后**，在 `docs/调试记录-主控与电机CAN.md` 中记录：
   - 时间、版本、硬件接线、固件版本。
   - CAN 配置（波特率、ID 分配等）。
   - 本次调试的目标、过程、现象、结论与 TODO。
2. 当你从 PDF 中确认了某条 **协议或约束条件**，就把它写进 `docs/规范-电机CAN与髋踝联动.md`，并标注来源页码。
3. 后续开始写代码时，在 `README.md` 中补充：
   - 开发环境（编译器/IDE/操作系统）。
   - 构建方式（如 CMake、Keil、VS Code + PlatformIO 等）。
   - 运行 / 烧录 / 调试步骤。

---

## 开发环境

- **硬件平台**：Teensy 4.1（IMXRT1062，600MHz）
- **开发工具**：PlatformIO + Cursor IDE
- **编译框架**：Arduino Framework
- **CAN 库**：FlexCAN_T4
- **串口波特率**：115200 bps
- **CAN 波特率**：1 Mbps

## 开发计划（基于康复训练需求）

### 阶段一：基础通讯与控制 ✅ **已完成**
- [x] CAN 协议实现（V2.35）
- [x] 电机使能/掉电/停止
- [x] 多圈角度读取
- [x] 位置控制指令
- [x] 串口交互调试工具
- [x] 摆动功能测试

### 阶段二：早期被动模式 📋 **规划中**
**目标**：对患者进行柔和的运动引导，采用标准步态

- [ ] 标准步态轨迹生成（髋踝联动曲线）
- [ ] 位置控制模式实现（柔和引导）
- [ ] 步态周期管理（相位识别、循环控制）
- [ ] 速度/加速度限制（确保运动柔和）
- [ ] 阻力检测与柔性响应（遇到强阻力时降低控制力度）

### 阶段三：主动激发模式 📋 **规划中**
**目标**：减弱被动控制力度，激发患者主动性

- [ ] 健侧腿步态学习与模拟
- [ ] 误差允许机制（避免人机对抗）
- [ ] 辅助强度可调（根据康复阶段调整）
- [ ] 患者意图感知（通过力矩/位置偏差判断）

### 阶段四：主动康复模式 📋 **规划中**
**目标**：力矩模式控制，按比例提供助力

- [ ] 力矩控制模式实现
- [ ] 患者意图感知算法
- [ ] 按比例助力策略
- [ ] 关键相位重点辅助（如踝关节屈伸）
- [ ] 混合控制策略（位置+力矩，根据动作阶段切换）

### 阶段五：精细化控制 📋 **规划中**
**目标**：根据不同动作阶段设置不同控制策略

- [ ] 步态相位识别（支撑相、摆动相等）
- [ ] 分阶段控制策略配置
- [ ] 安全限位与急停机制
- [ ] 数据记录与分析（用于康复评估）

## 编译和上传、调试命令

**Windows PowerShell 使用方式：**
```powershell
cd firmware
py -m platformio run                    # 编译
py -m platformio run -t upload          # 编译并上传
py -m platformio device monitor -b 115200  # 串口监视
```

**如果已配置 `pio` 命令别名，也可以直接使用：**
```bash
