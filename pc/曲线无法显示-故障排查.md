# 曲线无法显示 - 故障排查指南

## 问题症状

- ✅ 串口已连接，数据正在接收
- ✅ 步态相位、进度、角度数据显示正常  
- ❌ 图表中没有曲线，显示"等待数据..."

## 快速修复步骤

### 步骤 1：启用数据处理模块

从截图上看，相位数据已显示说明某个模块已在工作。但需要确保正确的模块被启用：

**方案 A：使用髋关节数据模块（推荐）**
1. 连接串口后
2. 点击左侧 **"髋关节数据: 关闭"** 按钮
3. 等待 1-2 秒，应该看到按钮变为 **"髋关节数据: 开启"**
4. 图表应该开始显示曲线

**方案 B：使用步态采集模块**
1. 点击左侧 **"步态采集: 关闭"** 按钮
2. 等待 1-2 秒，应该看到按钮变为 **"步态采集: 开启"**
3. 图表应该开始显示曲线

### 步骤 2：检查控制台输出

运行程序时打开一个终端窗口，查看是否有以下初始化信息：

```
[模块初始化] 髋关节数据模块启动
[模块状态] 髋关节处理线程已启动 (TID: xxxxx)
```

如果看不到这些信息，说明模块没有被正确启动。

### 步骤 3：检查 JSON 数据格式

在终端中查看是否有数据解析诊断信息（每 100 个数据点打印一次）：

```
[JSON解析] 跳过数据: 缺少字段 ['a'], 接收到的字段: ['t', 'h', 'hf', 'phase', 's', 'ar']
```

如果看到这样的信息，说明串口数据中缺少某些字段。

---

## 常见原因与解决方案

### 原因 1：模块未启用

**症状**：
- 图表显示"等待数据..."
- 模块状态显示 `✗`（关闭）

**解决**：
- 点击对应的模块按钮启用
- 检查终端是否有初始化日志

### 原因 2：JSON 字段缺失

**症状**：
- 队列大小显示 > 0（有数据）
- 但数据点数始终为 0

**解决**：
1. 检查固件是否发送了完整的 JSON 数据
2. 应至少包含以下字段：`t`（时间）、`h`（髋角）
3. 可选字段：`hf`（滤波髋角）、`phase`（相位）、`s`（进度）、`a`（踝角）、`ar`（踝参考角）

### 原因 3：两个模块冲突

**症状**：
- 同时启用了"步态采集"和"髋关节数据"
- 数据在两个模块之间竞争，部分丢失

**解决**：
- 只启用一个模块（推荐启用"髋关节数据"）
- 停止另一个模块

### 原因 4：内存缓冲区满

**症状**：
- 运行一段时间后曲线停止更新
- 高 CPU 占用

**解决**：
- 重新启动程序
- 参考性能优化指南调整 `MAX_DATA_POINTS`

---

## 诊断信息详解

### 图表显示信息示例

```
等待数据...
队列大小: 45 | 收到: 1250
数据点数: 0
步态模块: ✗ | 髋关节模块: ✓
[提示] 点击"髋关节数据"或"步态采集"启动数据处理
```

**各字段含义**：

| 字段 | 含义 | 解释 |
|------|------|------|
| 队列大小 | 0 | data_queue 中待处理的数据数量（应 <100） |
| 收到 | 1250 | 自连接以来接收的 JSON 数据总数 |
| 数据点数 | 0 | 成功添加到缓冲区的数据点（应>0 且递增） |
| 步态模块 | ✗ | 步态采集模块状态（✓=启用，✗=关闭） |
| 髋关节模块 | ✓ | 髋关节数据模块状态（✓=启用，✗=关闭） |

**诊断逻辑**：
- 如果收到 > 0 但数据点数 = 0：JSON 解析有问题
- 如果两个模块都是 ✗：需要启用至少一个
- 如果队列大小很大（>200）：处理速度跟不上

---

## 详细检查清单

### 1. 硬件连接

- [ ] 串口已连接（显示绿色"已连接"）
- [ ] 串口选择正确
- [ ] 数据线连接牢固
- [ ] LED 指示灯正常

### 2. 固件配置

- [ ] 固件已正确烧录
- [ ] 固件中 JSON 输出已启用
- [ ] 串口波特率为 115200
- [ ] JSON 数据格式正确

### 3. 软件配置

- [ ] 上位机已连接串口
- [ ] 至少一个数据处理模块已启用
- [ ] 没有多个实例同时运行
- [ ] Python 依赖库已安装（serial, matplotlib）

### 4. 数据验证

- [ ] 控制台显示有接收到数据
- [ ] JSON 数据能被正确解析
- [ ] 无 KeyError 或 JSONDecodeError
- [ ] 数据点数在持续增加

---

## 手动启用调试输出

编辑 `gait_data_collector_gui.py`，在 `_hip_process_loop` 或 `_gait_process_loop` 中添加：

```python
# 在异常处理中
except Exception as e:
    print(f"处理错误: {e}")
    import traceback
    traceback.print_exc()  # 打印完整堆栈跟踪
    time.sleep(0.01)

# 添加数据验证日志
if timestamp is not None and hip_raw is not None:
    print(f"✓ 数据接收: t={timestamp}, h={hip_raw}")
```

---

## 需要帮助？

检查以下文件获取更多信息：

1. **性能优化指南** - [曲线绘制性能优化指南.md](曲线绘制性能优化指南.md)
2. **使用指南** - [README_性能优化.md](README_性能优化.md)
3. **代码对比** - [优化对比代码详解.md](优化对比代码详解.md)

或查看控制台输出中的错误信息，并参考上面的常见原因部分。

