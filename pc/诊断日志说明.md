# 曲线不显示问题 - 诊断日志说明

## 问题概述
尽管串口接收数据正常、相位和进度显示正常（说明模块在工作），但图表上仍然显示"等待数据..."，没有绘制曲线。

## 已应用的诊断改进

### 1. 数据添加层诊断（_hip_process_loop）
**文件**: `gait_data_collector_gui.py` L354-384
**改进**: 每处理50个数据点时，打印所有缓冲区的长度

```
输出格式：
[_hip_process_loop] 已处理 50 个数据点 | 缓冲区长度: time=50, hip=50, filtered=50, ankle=50, phase=50, swing=50
```

**诊断作用**: 
- 确认数据是否真的被添加到缓冲区
- 检查各缓冲区长度是否一致（一致说明没有数据跳过）
- 如果某个缓冲区长度为0，说明该字段的数据有问题

---

### 2. 数据读取层诊断（get_realtime_data）
**文件**: `gait_data_collector_gui.py` L673-740
**改进**: 三层诊断日志

#### 第一层：缓冲区为空诊断 (L673-690)
```
输出格式：
[get_realtime_data] ⚠️ 缓冲区为空（初次）:
  time_data=0, hip_data=0, hip_filtered=0, ankle_deg=0
  hip_module_enabled=True, gait_module_enabled=False
```

**诊断作用**:
- 如果这条信息出现，说明缓冲区根本没有数据
- 检查模块启用状态，确认是哪个模块在工作

#### 第二层：最小长度为零诊断 (L695-707)
```
输出格式：
[get_realtime_data] ⚠️ min_len为0（初次）:
  time=1400, hip=1400, filtered=1400, ankle=0
```

**诊断作用**:
- 当time_data有数据但min_len为0时，说明某个缓冲区为空
- 上例中ankle_deg_data为0，说明没有收到踝关节数据

#### 第三层：成功返回诊断 (L730-738)
```
输出格式：
[get_realtime_data] ✓ 返回 1400 个数据点（共缓存 1400 个，hip_data 1400, 滤波 1400）
```

**诊断作用**:
- 只有数据被成功返回时才打印
- 每100个数据点打印一次，追踪数据流量

---

## 故障排查步骤

### 步骤1：检查[_hip_process_loop]日志
**预期输出**:
```
[_hip_process_loop] 已处理 50 个数据点 | 缓冲区长度: time=50, hip=50, filtered=50, ankle=50, ...
```

**如果看到**:
- ✓ 所有缓冲区长度都在增长 → 数据添加正常，转到步骤2
- ✗ 某个缓冲区始终为0 → 该字段的数据没有被接收，检查固件发送的JSON字段
- ✗ 完全没有这个日志 → 线程没有启动或被卡死

---

### 步骤2：检查[get_realtime_data]日志
**预期输出**:
```
[get_realtime_data] ✓ 返回 1400 个数据点（共缓存 1400 个，...)
```

**如果看到**:
- ✓ 返回的数据点数在增长 → 数据读取正常，转到步骤3
- ⚠️ "缓冲区为空" 警告 → 尽管_hip_process_loop显示有数据，但读取时为空（可能线程同步问题）
- ⚠️ "min_len为0" 警告 → 某个缓冲区为空，查看具体缺少哪个字段

---

### 步骤3：检查绘制层
如果上述日志都正常，但仍无曲线，问题在于绘制层：
- 检查 `update_plots()` 中 `new_len > 0` 的条件是否被满足
- 检查 matplotlib canvas 是否成功调用 `draw_idle()`

---

## 可能的问题场景

### 场景1：所有缓冲区都为空
```
[get_realtime_data] ⚠️ 缓冲区为空（初次）:
  time_data=0, hip_data=0, hip_filtered=0, ankle_deg=0
  hip_module_enabled=True, gait_module_enabled=False
```
**原因**: 髋关节模块启动了，但没有接收到数据
**解决**: 检查串口连接和JSON解析

---

### 场景2：某个缓冲区为0（最常见）
```
[_hip_process_loop] 已处理 50 个数据点 | 缓冲区长度: time=50, hip=50, filtered=50, ankle=0, phase=50, swing=50
```
**原因**: 固件没有发送某个字段（如'a' for ankle_deg）
**解决**: 检查固件是否发送了该字段的数据

---

### 场景3：两个日志都正常但没有曲线
```
[_hip_process_loop] 已处理 50 个数据点 | 缓冲区长度: time=50, hip=50, ...
[get_realtime_data] ✓ 返回 50 个数据点（共缓存 50 个，...）
```
**但图表仍显示"等待数据..."**
**原因**: 绘制逻辑有问题
**解决**: 检查matplotlib绘制是否出错

---

## 关键观察

1. **数据添加和读取分离**: 诊断日志清楚地分离了数据添加层和数据读取层，帮助快速定位问题
2. **缓冲区一致性检查**: 通过打印所有缓冲区长度，可以立即看出是否有字段数据缺失
3. **模块状态检查**: 显示启用状态，防止用户不知道哪个模块在工作

---

## 运行新版本的建议

1. **重新运行** `gait_data_collector_gui.py`
2. **点击"髋关节数据"启动模块**
3. **观察终端日志**，特别是：
   - 是否看到 `[_hip_process_loop] 已处理 50 个数据点...` 的日志？
   - 是否看到 `[get_realtime_data] ✓ 返回...` 的日志？
4. **分享完整的终端输出**，特别是这两行日志的具体内容

这样可以快速判断问题出在哪一层。
