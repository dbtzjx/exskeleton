# 调整开发计划V1

状态: 进行中

# 单侧踝外骨骼开发计划（From 0 → 1）

**适用对象**

- 中风恢复期（B 人群）
- 有主动参与能力，但踝背屈不足，步态中存在脚尖拖地

**核心目标**

- 在不抑制主动运动的前提下
- 在摆动相提供“最小必要”的踝背屈辅助
- 实现安全、顺从、可调、可扩展的工程系统

---

## 1. 系统边界与基本假设

### 1.1 硬件假设

- 单侧踝关节外骨骼
- 踝关节：**连杆驱动**
- 电机控制：FOC，支持位置控制（0xA4）、状态反馈（角度 / 速度 / iq / 温度）
- 髋关节：已存在电机，可读取编码器角度
- 控制频率：100 Hz

### 1.2 传感与信号

- **相位识别仅使用髋关节角度**（暂不使用 FSR / IMU）
- 踝关节解剖角度零点定义：
    
    **脚掌与小腿成 90° = 0°**
    
    - 背屈：正角度
    - 跖屈：负角度

---

## 2. 踝关节角度标定（必须实现）

### 2.1 零点校准流程

新增命令：`az`（ankle zero）

1. 穿戴完成后，用户站立在自然中立位
2. 读取当前踝电机多圈编码器角 `pos_raw`
3. 保存：
    
    ```
    ankle_zero_offset = pos_raw
    
    ```
    
4. 后续踝解剖角计算：
    
    ```
    ankle_deg = (pos_raw - ankle_zero_offset) * k_deg
    
    ```
    

> ⚠️ 所有控制、限位、保护都基于 ankle_deg，此步骤不做系统不可用
> 

---

## 3. 步态相位识别（基于髋角，100 Hz）

### 3.1 信号预处理

- 髋角低通滤波（EMA）：
    
    ```
    hip_f = hip_f + α * (hip_raw - hip_f)
    α = 0.15 ~ 0.25
    
    ```
    
- 髋角速度：
    
    ```
    hip_vel = (hip_f - hip_f_prev) / dt
    
    ```
    
- 髋角速度再滤波（EMA）：
    
    ```
    hip_vel_f = hip_vel_f + β * (hip_vel - hip_vel_f)
    β = 0.2
    
    ```
    

---

### 3.2 自适应阈值

维护 2 秒滑动窗口：

- `hip_mean`：均值
- `hip_amp`：幅度（max-min 或 P95-P05）

阈值定义：

```
A_up = 0.2 * hip_amp
A_dn = 0.2 * hip_amp
V_up = +20 deg/s
V_dn = -20 deg/s

```

最短持续时间（防抖）：

```
T_hold = 80 ms

```

---

### 3.3 相位判定逻辑（两态）

### 进入摆动相 SWING

- `hip_vel_f > V_up`
- `hip_f > hip_mean + A_up`
- 连续满足 ≥ T_hold

### 进入支撑相 STANCE

- `hip_vel_f < V_dn`
- `hip_f < hip_mean - A_dn`
- 连续满足 ≥ T_hold

---

### 3.4 摆动相进度（用于踝控制）

- 记录当前摆动时长 `t_swing`
- 维护摆动平均周期：
    
    ```
    Ts = 0.8 * Ts + 0.2 * t_swing
    
    ```
    
    初始 `Ts = 0.4 s`
    
- 摆动进度：
    
    ```
    s = clamp(t_swing / Ts, 0, 1)
    
    ```
    

---

## 4. 踝背屈辅助策略（B 人群核心）

### 4.1 控制原则

- **只在摆动相介入**
- **只在患者抬不够时补偿**
- 患者抬得越好 → 设备帮得越少
- 不做“全程强制轨迹”

---

### 4.2 目标角与安全限位

### 背屈窗口

```
θ_low  = +2°
θ_high = +8°

```

### 软限位（起始保守值）

```
θ_min = -15°   （跖屈）
θ_max = +15°   （背屈）

```

---

### 4.3 摆动相目标曲线

使用 S 曲线平滑抬脚：

```
u = s*s*(3 - 2*s)
θ_target = θ_low + (θ_high - θ_low) * u

```

---

### 4.4 “窗口辅助”核心逻辑

最终下发的踝关节参考角：

```
if ankle_deg >= θ_low:
    θ_ref = ankle_deg       // 不压人，让他自己抬
else:
    θ_ref = max(ankle_deg, θ_target)

```

---

### 4.5 助力衰减（推荐）

完成度：

```
p = clamp((ankle_deg - θ_min) / (θ_low - θ_min), 0, 1)
assist = 1 - p

```

`assist` 可用于：

- 缩小最大速度
- 减慢 θ_ref 上升速度

---

## 5. 顺从与软化控制（必须）

### 5.1 阈值定义（初始值）

> 实际应通过日志校准，以下为起始工程值
> 

### 电流阈值

```
I1 = 轻度阻力阈值
I2 = 重度阻力阈值

```

### 位置误差阈值

```
E1 = 3°
E2 = 7°

```

### 持续时间

```
T_resist = 80 ms

```

---

### 5.2 控制状态机

| 状态 | 行为 |
| --- | --- |
| NORMAL | 正常辅助 |
| COMPLIANT | 降低 maxSpeed，减缓推进 |
| HOLD | 停止推进，保持当前位置 |
| FAULT_SAFE | 故障保护 |

### 进入条件

- `|iq| > I1` 或 `|θ_ref - θ| > E1` → COMPLIANT
- `|iq| > I2` 或 `|θ_ref - θ| > E2` → HOLD
- 越界 / 超温 / 通讯超时 → FAULT_SAFE

### 退出条件

- 阻力低于 I1 持续 200~300 ms

---

## 6. 软件结构建议（下位机）

### 6.1 模块划分

- `SensorManager`
    - 髋 / 踝角度、速度、iq、温度
- `GaitPhaseDetector`
    - phase、swing_progress
- `AssistController`
    - θ_ref、maxSpeed、assist_mode
- `SafetyManager`
    - 限位、超时、故障

### 6.2 主循环（100 Hz）

1. 更新传感器状态
2. 相位识别
3. 计算踝辅助输出
4. 安全检查
5. 下发踝位置命令（0xA4）

---

## 7. 调试与参数命令建议

- `az`：踝零点校准
- `p`：打印当前状态
- `set th_low <deg>`
- `set th_high <deg>`
- `set vmax_n <val>`
- `set vmax_c <val>`
- `set i1 <val>`
- `set i2 <val>`
- `enable assist`
- `disable assist`

---

## 8. 里程碑与验收

### M1：相位识别

- 相位稳定，无抖动
- Ts 收敛在 0.3–0.6 s

### M2：摆动相抬脚

- SWING 内踝角 ≥ θ_low
- 主动背屈时，电机输出下降

### M3：顺从与安全

- 人为阻挡不硬顶
- 故障可恢复

---

## 9. 后续扩展方向（非当前阶段）

- 力矩 / 阻抗控制
- FSR / IMU 融合相位
- 主动康复评估指标
- 髋踝联动（相位参考）

---

**版本**：v1.0

**定位**：工程可落地 / 康复导向

**下一步**：跑通 M1 + M2 实机闭环，记录日志后细化阈值

---