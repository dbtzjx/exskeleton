# 步态检测算法 V2 优化指南

## 概述
本文档说明了步态检测算法从"基于均值的相对判定"到"基于零点的绝对+趋势判定"的升级改进。该升级能显著提高踝关节背屈辅助的响应速度，有效防止拖地现象。

---

## 核心改进

### 1. 移除基于均值的相对判定，采用绝对+趋势判定

**原始方法（已弃用）**：
```cpp
// 基于 hip_mean 的相对判定
bool swingConditionMet = (hip_vel_f < V_dn) && (hip_f < hip_mean - A_dn);
bool stanceConditionMet = (hip_vel_f > V_up) && (hip_f > hip_mean + A_up);
```

**新方法**：
```cpp
// 基于零点的绝对+趋势判定
// SWING：腿向前迈出超过 5° 且带有向前的速度（hip_vel_f > 10.0f）
bool swingConditionMet = (hip_f > 5.0f) && (hip_vel_f > V_up);

// STANCE：腿已摆到最高点开始下落（速度变负，hip_vel_f < -10.0f）
bool stanceConditionMet = (hip_vel_f < -10.0f);
```

**改进效果**：
- ✅ 摆动相检测提前：不再等待角度变化，只要腿向前超过 5° 就进入 SWING
- ✅ 踝背屈辅助更及时：提前约 100-200ms 激活辅助，显著防止拖地
- ✅ 生理步态更符合：Heel Strike（落地）瞬间的速度过零判定更准确

---

### 2. 增加幅值下限保护

**实现**：
```cpp
float effective_amp = (adaptiveThreshold.hip_amp < 15.0f) ? 15.0f : adaptiveThreshold.hip_amp;
```

**目的**：
- 防止用户坐着或站立时微动（1-2°）导致状态疯狂跳变
- 当 hip_amp < 15° 时，使用 15° 作为有效幅度
- 避免小角度波动触发状态转换

---

### 3. 关键参数调整

| 参数 | 原值 | 新值 | 说明 |
|------|------|------|------|
| `V_up` | 20.0 f | 10.0 f | SWING 进入时的速度阈值，降低使响应更快 |
| `V_dn` | -20.0 f | -10.0 f | STANCE 进入时的速度阈值（过零判定） |
| `hip_f 绝对阈值` | 无 | 5.0 f | 进入 SWING 的髋角绝对阈值（度） |
| `hip_amp 下限` | 无 | 15.0 f | 幅值下限保护（度） |

---

### 4. 调试输出

代码现在每 100ms 输出一次调试信息，便于观察步态检测状态：

```cpp
// 输出格式：HipF: <髋角> VelF: <髋速度> State: <状态*10>
// 示例：HipF: 15.32 VelF: 28.45 State: 10 (进入 SWING)
// 示例：HipF: -5.21 VelF: -12.34 State: 0  (进入 STANCE)
```

**串口绘图器配置**：
- 波特率：根据主程序设置（通常 115200）
- 数据格式：逐行读取，自动解析 HipF 和 State 字段
- State 值说明：0 = STANCE（支撑相），10 = SWING（摆动相）

---

## 调试指南

### 问题诊断表

#### 问题 1：静止时容易误触发进入 SWING（状态疯狂闪烁）

**症状**：
- 用户站立不动，但串口显示状态在 0 和 10 之间反复跳跃
- hip_f 和 hip_vel_f 数值波动但不规律

**解决方案**：
1. **调大 V_up**（当前 10.0 f，可试试 15.0 f）
   - V_up 是进入 SWING 时的速度阈值，值越大越难进入
   - 修改位置：[firmware/src/main.cpp L251](../firmware/src/main.cpp#L251)

```cpp
adaptiveThreshold.V_up = 15.0f;  // 从 10.0f 改为 15.0f
```

2. **增加 T_HOLD_MS**（当前 80 ms，可试试 150 ms）
   - 防抖时间越长，状态转换越稳定
   - 修改位置：[firmware/src/main.cpp L223](../firmware/src/main.cpp#L223)

```cpp
const uint32_t T_HOLD_MS = 150;  // 从 80ms 改为 150ms
```

---

#### 问题 2：起步辅助太迟，踝关节背屈反应慢

**症状**：
- 用户开始走路时，踝关节背屈辅助延迟明显（>200ms）
- 容易发生初始拖脚

**解决方案**：
1. **调小 V_up**（当前 10.0 f，可试试 5.0 f）
   - 降低速度阈值，使 SWING 进入条件更容易满足

```cpp
adaptiveThreshold.V_up = 5.0f;  // 从 10.0f 改为 5.0f
```

2. **降低 hip_f 绝对阈值**（当前 5.0°，可试试 3.0°）
   - 腿向前摆动角度需要更小就能触发 SWING

```cpp
// 在 updateGaitPhaseDetector() 函数中修改
bool swingConditionMet = (hip_f > 3.0f) && (hip_vel_f > V_up);  // 从 5.0f 改为 3.0f
```

---

#### 问题 3：在 SWING 相坚持太久，不能及时切换到 STANCE

**症状**：
- 踝关节背屈持续时间过长，甚至在着地后还在背屈
- STANCE 状态不能及时触发

**解决方案**：
1. **调大负速度阈值的绝对值**（当前 -10.0 f，可试试 -8.0 f）
   - 更早检测到速度过零（下落阶段开始）

```cpp
adaptiveThreshold.V_dn = -8.0f;  // 从 -10.0f 改为 -8.0f
```

2. **观察 hip_vel_f 的实际值**
   - 在串口输出中确认速度是否真正变成负值
   - 如果 hip_vel_f 最小值是 -5.0 f，则需要调整阈值到 -4.0 f

---

#### 问题 4：用户坐着或站立时微动导致状态跳变

**症状**：
- 用户坐下但脚还在地面上微动，状态频繁变化
- 踝电机不停发出辅助指令

**解决方案**：
- **幅值下限已设置为 15.0 f，一般不需要调整**
- 如果问题依然存在，可增加下限：

```cpp
float effective_amp = (adaptiveThreshold.hip_amp < 20.0f) ? 20.0f : adaptiveThreshold.hip_amp;
```

---

## 轨迹百分比映射（进阶）

### 时间相位 vs 空间相位

**当前实现（时间相位）**：
```
swing_progress = t_swing / Ts
```
- 优点：简单稳定
- 缺点：用户摆腿快和慢时，辅助参数完全相同

**推荐实现（空间相位）**：
```
space_phase = (hip_f - hip_min) / (hip_max - hip_min)
```
- 优点：更符合人体运动规律，自适应用户摆腿速度
- 缺点：需要跟踪摆动周期中的 hip_max 和 hip_min

### 实现建议

在 `updateSwingProgress()` 中补充计算：

```cpp
// 计算当前摆动周期中的 hip_max 和 hip_min
if (currentPhase == PHASE_SWING) {
  static float swing_max = hipProcessor.hip_f;
  static float swing_min = hipProcessor.hip_f;
  
  swing_max = max(swing_max, hipProcessor.hip_f);
  swing_min = min(swing_min, hipProcessor.hip_f);
  
  // 空间相位计算
  if (swing_max > swing_min) {
    float space_phase = (hipProcessor.hip_f - swing_min) / (swing_max - swing_min);
    swingProgress.swing_progress = clamp(space_phase, 0.0f, 1.0f);
  }
} else {
  // STANCE 阶段，重置最值
  swing_max = hipProcessor.hip_f;
  swing_min = hipProcessor.hip_f;
}
```

---

## 测试建议

### 1. 静止测试
- [ ] 用户站立不动 30 秒，观察串口输出
- [ ] 确保状态始终为 0（STANCE），不出现闪烁

### 2. 步行测试
- [ ] 用户以正常速度步行
- [ ] 观察 HipF 和 State 的对应关系
- [ ] 踝关节背屈应在 SWING 早期（约 0-10% 进度）激活

### 3. 极限测试
- [ ] 快速步行：验证高速摆腿时的响应性
- [ ] 缓慢步行：验证低速摆腿时的稳定性
- [ ] 微动测试：验证幅值下限保护是否有效

### 4. 数据记录
- 使用串口工具保存 1-2 分钟的日志
- 用 Python 脚本解析数据并绘制 hip_f 和 state 的时域波形
- 分析踝背屈辅助的响应延迟

---

## 文件修改总结

修改的文件：[firmware/src/main.cpp](../firmware/src/main.cpp)

**关键修改点**：

| 行号 | 修改内容 |
|------|---------|
| L135-L157 | 添加算法V2的概述和参数说明注释 |
| L223-L242 | 添加参数调整指南 |
| L348-L362 | 更新 `updateGaitPhaseDetector()` 的判定逻辑 |
| L390-L406 | 添加调试输出（每100ms打印一次） |
| L228-L251 | 修改 `updateAdaptiveThreshold()` 的参数计算 |
| L466-L485 | 添加空间相位映射的说明文档 |

---

## 相关文档参考

- [项目概览](项目概览.md)
- [开发计划](开发计划.md)
- [调试记录-主控与电机CAN](调试记录-主控与电机CAN.md)
- [规范-电机CAN与髋踝联动](规范-电机CAN与髋踝联动.md)

---

## 联系与反馈

如在调试过程中遇到问题或有改进建议，请：
1. 记录串口输出数据
2. 描述问题现象和复现步骤
3. 参考本文档的诊断表进行初步排查
4. 根据建议调整参数并重新测试

