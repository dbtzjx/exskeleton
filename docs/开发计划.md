# 康复外骨骼控制程序开发计划

> **重要更新**：根据《调整开发计划V1.md》，开发方向已调整为单侧踝外骨骼辅助系统

## 新开发方向概述

**适用对象**：中风恢复期（B人群），有主动参与能力，但踝背屈不足，步态中存在脚尖拖地

**核心目标**：
- 在不抑制主动运动的前提下
- 在摆动相提供"最小必要"的踝背屈辅助
- 实现安全、顺从、可调、可扩展的工程系统

**控制策略转变**：
- **旧策略**：被动播放完整步态轨迹（gp命令）
- **新策略**：只在摆动相、只在患者抬不够时提供补偿（窗口辅助）

---

## 开发阶段规划（按新计划）

### ✅ 阶段一：基础通讯与控制（已完成）

**目标**：完成主控与电机的基础通讯，实现基本控制功能

**已完成任务**：
- [x] CAN 协议实现（V2.35）
- [x] 电机使能/掉电/停止命令
- [x] 多圈角度读取（命令 0x92）
- [x] 位置控制指令（命令 0xA3/0xA4）
- [x] 反馈帧解析（状态、角度、速度、温度等）
- [x] 串口交互调试工具
- [x] 摆动功能测试

**测试状态**：✅ 基础功能测试通过

---

### 🔄 阶段二：单侧踝外骨骼辅助系统（进行中）

**目标**：实现基于髋关节角度的步态相位识别，在摆动相提供最小必要的踝背屈辅助

**控制特点**：
- 只在摆动相介入
- 只在患者抬不够时补偿
- 患者抬得越好 → 设备帮得越少
- 不做"全程强制轨迹"

**开发任务**：

#### 2.1 踝关节角度标定 🔄
- [x] 实现`az`命令（ankle zero）
- [x] 零点校准流程（读取当前角度，保存`ankle_zero_offset`）
- [x] 修改踝关节角度计算，使用零点偏移
- [ ] 标定状态持久化（EEPROM保存，上电自动加载）
- [ ] 标定验证与测试

**测试状态**：✅ 基础功能已实现，待测试

#### 2.2 髋关节信号预处理 ✅
- [x] 髋角低通滤波（EMA，α = 0.2）
- [x] 髋角速度计算（差分）
- [x] 髋角速度滤波（EMA，β = 0.2）
- [x] 信号预处理测试

**测试状态**：✅ 已实现并通过测试，上位机可完美采集并看到滤波效果

#### 2.3 自适应阈值计算 ✅
- [x] 2秒滑动窗口实现（200个数据点 @ 100Hz）
- [x] `hip_mean`计算（均值）
- [x] `hip_amp`计算（幅度，max-min）
- [x] 阈值定义（A_up = 0.2*hip_amp, A_dn = 0.2*hip_amp, V_up = +20 deg/s, V_dn = -20 deg/s）
- [x] 防抖时间（T_hold = 80ms）
- [x] 调试命令（`th`命令查看阈值状态）
- [x] 数据输出（在`sendGaitData`中包含阈值数据）

**测试状态**：✅ 已实现，待测试

#### 2.4 步态相位识别 ✅
- [x] 两态状态机（SWING/STANCE）
- [x] 进入摆动相条件（hip_vel_f > V_up, hip_f > hip_mean + A_up, 持续≥T_hold）
- [x] 进入支撑相条件（hip_vel_f < V_dn, hip_f < hip_mean - A_dn, 持续≥T_hold）
- [x] 防抖逻辑实现（T_hold = 80ms）
- [x] 相位持续时间跟踪
- [x] 调试命令（`phase`命令查看相位状态）
- [x] 数据输出（在`sendGaitData`中包含相位信息）

**测试状态**：✅ 已实现，待测试

#### 2.5 摆动相进度计算 ✅
- [x] 摆动时长记录（t_swing）
- [x] 摆动平均周期自适应（Ts = 0.8*Ts + 0.2*t_swing，初始Ts = 0.4s）
- [x] 摆动进度计算（s = clamp(t_swing/Ts, 0, 1)）
- [x] 相位切换检测和平均周期更新逻辑
- [x] 数据输出（在`sendGaitData`中包含Ts、t_swing、s）
- [x] 调试命令（`swing`命令查看摆动进度状态）

**测试状态**：✅ 已实现，待测试

#### 2.6 踝背屈辅助策略 ✅
- [x] 目标角定义（θ_low = +2°, θ_high = +8°）
- [x] 安全限位（θ_min = -15°, θ_max = +15°）
- [x] S曲线目标角计算（u = s*s*(3-2*s), θ_target = θ_low + (θ_high-θ_low)*u）
- [x] 窗口辅助核心逻辑（if ankle_deg >= θ_low: θ_ref = ankle_deg; else: θ_ref = max(ankle_deg, θ_target)）
- [x] 助力衰减计算（p = clamp((ankle_deg-θ_min)/(θ_low-θ_min), 0, 1), assist = 1-p）
- [x] 只在摆动相介入逻辑
- [x] 数据输出（在`sendGaitData`中包含theta_ref、theta_target、assist）
- [x] 调试命令（`assist`命令查看辅助策略状态，`assiston`/`assistoff`启用/禁用）

**测试状态**：✅ 已实现，待测试
**注意**：当前仅计算参考角度，实际电机控制需要在主循环重构（2.8）中实现

#### 2.7 顺从与软化控制 ✅
- [x] 电流阈值定义（I1=500mA轻度阻力, I2=1000mA重度阻力）
- [x] 位置误差阈值（E1 = 3°, E2 = 7°）
- [x] 控制状态机（NORMAL, COMPLIANT, HOLD, FAULT_SAFE）
- [x] 状态转换逻辑（进入/退出条件）
  - [x] 进入COMPLIANT：|iq| > I1 或 |θ_ref - θ| > E1
  - [x] 进入HOLD：|iq| > I2 或 |θ_ref - θ| > E2
  - [x] 进入FAULT_SAFE：越界/超温/通讯超时
  - [x] 退出条件：阻力低于I1持续250ms
- [x] 速度因子控制（NORMAL=1.0, COMPLIANT=0.5, HOLD=0.0）
- [x] 故障检测（温度、通讯超时、位置越界）
- [x] 数据输出（在`sendGaitData`中包含comp_state、iq、speed_factor）
- [x] 调试命令（`compliance`命令查看状态，`resetfault`重置故障）

**测试状态**：✅ 已实现，待测试

#### 2.8 主循环重构（待开发）
- [ ] 控制频率调整为100Hz（10ms周期）
- [ ] 模块化设计（SensorManager, GaitPhaseDetector, AssistController, SafetyManager）
- [ ] 主循环集成（传感器更新 → 相位识别 → 辅助计算 → 安全检查 → 下发命令）
- [ ] 性能优化与测试

**预期时间**：3-4 周

---

### 📋 阶段三：调试与参数优化（规划中）

**目标**：通过实机测试，优化各模块参数，确保系统稳定可靠

**开发任务**：
- [ ] 相位识别稳定性调试
- [ ] 辅助策略参数调优（θ_low, θ_high, 速度限制等）
- [ ] 顺从控制阈值校准（I1, I2, E1, E2）
- [ ] 安全限位验证
- [ ] 长时间运行稳定性测试

**预期时间**：1-2 周

---

### 📋 阶段四：功能扩展（规划中）

**目标**：添加调试命令、参数配置、数据记录等功能

**开发任务**：
- [ ] 调试命令实现（`p`打印状态, `set`参数配置等）
- [ ] 参数持久化（EEPROM保存配置）
- [ ] 数据记录功能（角度、速度、相位、辅助状态等）
- [ ] 上位机调试界面扩展

**预期时间**：1-2 周

---

## 里程碑与验收

### M1：相位识别 ✅（待实现）
- [ ] 相位稳定，无抖动
- [ ] Ts收敛在0.3-0.6s

### M2：摆动相抬脚 ✅（待实现）
- [ ] SWING内踝角≥θ_low
- [ ] 主动背屈时，电机输出下降

### M3：顺从与安全 ✅（待实现）
- [ ] 人为阻挡不硬顶
- [ ] 故障可恢复

---

## 技术要点

### 硬件配置
- **主控**：Teensy 4.1（IMXRT1062，600MHz）
- **CAN 波特率**：1 Mbps
- **髋关节电机 (ID 1)**：1° = 3600 单位（减速比1:36）
- **踝关节电机 (ID 2)**：1° = 1000 单位（减速比1:10）
- **控制频率**：100 Hz（10ms周期）

### 关键控制参数

#### 踝关节角度定义
- **零点**：脚掌与小腿成90° = 0°
- **背屈**：正角度
- **跖屈**：负角度

#### 相位识别参数
- **髋角滤波**：α = 0.15~0.25（EMA）
- **速度滤波**：β = 0.2（EMA）
- **自适应阈值**：A_up = 0.2*hip_amp, A_dn = 0.2*hip_amp
- **速度阈值**：V_up = +20 deg/s, V_dn = -20 deg/s
- **防抖时间**：T_hold = 80ms

#### 辅助策略参数
- **背屈窗口**：θ_low = +2°, θ_high = +8°
- **安全限位**：θ_min = -15°, θ_max = +15°
- **摆动周期**：初始Ts = 0.4s

#### 顺从控制参数（初始值，需校准）
- **电流阈值**：I1（轻度阻力）, I2（重度阻力）
- **位置误差**：E1 = 3°, E2 = 7°
- **持续时间**：T_resist = 80ms

### 控制模式
- **位置模式**：命令 0xA4（多圈位置闭环控制2，带速度限制）
- **位置单位**：0.01°/LSB（协议单位）
- **速度单位**：1 dps/LSB

---

## 当前进度

### 已完成
1. ✅ 基础CAN通信和电机控制
2. ✅ 踝关节角度标定功能（az命令）基础实现
3. ✅ 髋关节信号预处理（EMA滤波、速度计算）
4. ✅ 自适应阈值计算（2秒滑动窗口、均值幅度计算、阈值定义）
5. ✅ 步态相位识别（两态状态机、防抖逻辑、相位持续时间跟踪）
6. ✅ 摆动相进度计算（摆动时长记录、平均周期自适应、进度计算）
7. ✅ 踝背屈辅助策略（S曲线目标角、窗口辅助逻辑、助力衰减）
8. ✅ 顺从与软化控制（阻力检测、状态机、阈值定义、故障保护）

### 进行中
1. 🔄 顺从与软化控制测试与优化

### 下一步
1. 主循环重构（100Hz控制频率，集成所有模块，实际发送控制命令）
2. 实机测试与参数优化

---

## 注意事项

1. **安全第一**：所有控制策略都要有安全限位和急停机制
2. **顺从控制**：遇到阻力要降低控制力度，避免硬顶
3. **最小辅助**：只在患者抬不够时补偿，不抑制主动运动
4. **可调参数**：所有控制参数都要可调，便于调试和优化
5. **数据记录**：记录关键数据，用于分析和优化
6. **分阶段测试**：每个阶段都要充分测试，确保稳定可靠

---

## 参考文档

- 《调整开发计划V1.md》- 新开发计划详细说明
- 《电机CAN总线通讯协议（V2.35）整理.md》- CAN协议文档
- 《髋踝联动调试方案V2.md》- 原始开发方案
