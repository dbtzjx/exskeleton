# 康复外骨骼控制程序开发计划

> 基于《髋踝联动调试方案V2.md》制定的系统开发计划

## 控制原则

1. **柔和引导**：将肢体柔和的送到指定位置，遇到强阻力要有一定的柔性
2. **避免刚性**：整体控制要柔和，不能像机器人一样带着病人动
3. **可调辅助**：辅助强度要能调节，按照不同阶段康复需求，患者主动性越强，辅助强度越弱

---

## 开发阶段规划

### ✅ 阶段一：基础通讯与控制（已完成）

**目标**：完成主控与电机的基础通讯，实现基本控制功能

**已完成任务**：
- [x] CAN 协议实现（V2.35）
- [x] 电机使能/掉电/停止命令
- [x] 多圈角度读取（命令 0x92）
- [x] 位置控制指令（命令 0xA3/0xA4）
- [x] 反馈帧解析（状态、角度、速度、温度等）
- [x] 串口交互调试工具
- [x] 摆动功能测试

**测试状态**：✅ 基础功能测试通过

---

### 🔄 阶段二：早期被动模式（进行中）

**目标**：对患者进行柔和的运动引导，采用标准步态

**控制特点**：
- 位置模式为主
- 采用标准步态
- 柔和引导，避免刚性控制

**开发任务**：

#### 2.0 步态数据采集系统 ✅
- [x] 下位机数据采集功能（Teensy 4.1）
- [x] 上位机GUI数据可视化（Python Tkinter）
- [x] 实时数据采集与显示（髋关节、踝关节角度）
- [x] 步态周期自动检测
- [x] 数据保存与载入功能（步态周期数据 + 实时数据）
- [x] 数据文件管理（保存到data文件夹）
- [x] 串口控制功能集成

**测试状态**：✅ 步态检测上位机开发完成，可以实时检测髋踝两个关节的角度，并保存到data文件夹

#### 2.1 标准步态轨迹生成 ✅
- [x] 研究标准步态数据（髋关节、踝关节角度曲线）
- [x] 实现步态轨迹生成函数（线性插值）
- [x] 髋踝联动关系实现（根据髋角度计算踝角度，预留接口）
- [x] 轨迹平滑处理（移动平均滤波，确保运动柔和）
- [x] 步态周期管理（循环控制、频率可调）
- [x] 串口命令控制（gp <freq> <speed>, gps）
- [x] 从上位机加载实际步态数据（loadgait命令，JSON格式）
- [x] 以当前位置为中心的轨迹播放

**测试状态**：✅ 基础功能已实现，支持默认测试轨迹（正弦波）和实际采集数据加载，支持频率和速度可调，轨迹以当前位置为中心播放

#### 2.2 步态周期管理
- [ ] 步态周期定义（支撑相、摆动相等）
- [ ] 相位识别算法
- [ ] 循环控制逻辑
- [ ] 步态频率可调

#### 2.3 位置控制优化 ✅
- [x] 速度限制（确保运动柔和）
- [x] 加速度限制（速度平滑器，限制加速度变化）
- [x] 轨迹平滑处理（smoothstep插值，确保位置/速度曲线连续）
- [x] 阻力检测（通过电流/位置偏差判断）
- [x] 柔性响应（遇到强阻力时降低控制力度，调整目标位置和速度）
- [ ] 位置控制精度调试

#### 2.4 髋踝联动实现
- [ ] 联动关系函数实现
- [ ] 联动控制逻辑
- [ ] 联动测试与调试

**预期时间**：2-3 周

---

### 📋 阶段三：主动激发模式（规划中）

**目标**：减弱被动模式的控制力度，以激发患者主动性为主

**控制特点**：
- 模拟健侧腿的运动模式进行训练
- 避免人机对抗，允许误差存在
- 辅助强度可调

**开发任务**：

#### 3.1 健侧腿步态学习
- [ ] 健侧腿运动轨迹记录
- [ ] 步态数据存储与管理
- [ ] 步态模式识别
- [ ] 模拟健侧腿运动模式

#### 3.2 误差允许机制
- [ ] 位置误差阈值设置
- [ ] 误差检测算法
- [ ] 允许患者主动偏离预设轨迹
- [ ] 避免人机对抗逻辑

#### 3.3 辅助强度调节
- [ ] 辅助强度参数定义（0-100%）
- [ ] 根据康复阶段调整辅助强度
- [ ] 患者主动性评估（通过位置偏差、力矩等）
- [ ] 动态调整辅助强度

**预期时间**：3-4 周

---

### 📋 阶段四：主动康复模式（规划中）

**目标**：主要采用力矩模式进行控制，感知患者意图，按比例提供助力

**控制特点**：
- 力矩模式为主
- 感知患者意图
- 适时按比例提供助力
- 混合控制策略（关键相位重点辅助）

**开发任务**：

#### 4.1 力矩控制模式
- [ ] 转矩闭环控制实现（命令 0xA1）
- [ ] 力矩指令发送
- [ ] 力矩反馈解析
- [ ] 力矩限制与安全保护

#### 4.2 患者意图感知
- [ ] 位置偏差分析
- [ ] 力矩/电流分析
- [ ] 意图识别算法
- [ ] 意图强度评估

#### 4.3 按比例助力策略
- [ ] 助力比例计算
- [ ] 根据患者意图调整助力
- [ ] 助力平滑处理

#### 4.4 混合控制策略
- [ ] 关键相位识别（如踝关节屈伸）
- [ ] 关键相位重点辅助
- [ ] 位置+力矩混合控制
- [ ] 根据动作阶段切换控制策略

**预期时间**：4-5 周

---

### 📋 阶段五：精细化控制（规划中）

**目标**：根据不同动作阶段设置不同控制策略

**控制特点**：
- 控制颗粒度细
- 根据不同的动作阶段设置不同的控制策略
- 关键相位重点辅助

**开发任务**：

#### 5.1 步态相位识别
- [ ] 支撑相识别
- [ ] 摆动相识别
- [ ] 相位切换检测
- [ ] 相位状态机实现

#### 5.2 分阶段控制配置
- [ ] 不同动作阶段的控制参数配置
- [ ] 控制策略切换逻辑
- [ ] 参数可调（通过串口或配置文件）

#### 5.3 安全与评估
- [ ] 安全限位实现
- [ ] 急停机制
- [ ] 异常检测与处理
- [ ] 数据记录（角度、速度、力矩等）
- [ ] 康复评估指标计算

**预期时间**：3-4 周

---

## 技术要点

### 硬件配置
- **主控**：Teensy 4.1（IMXRT1062，600MHz）
- **CAN 波特率**：1 Mbps
- **髋关节电机 (ID 1)**：1° = 3600 单位
- **踝关节电机 (ID 2)**：1° = 1000 单位

### 关键控制参数
- **位置控制单位**：0.01°/LSB（协议单位）
- **速度单位**：1 dps/LSB
- **力矩控制范围**：-2048 ~ 2048（对应不同电机有不同实际电流范围）

### 控制模式切换
- **位置模式**：命令 0xA3（多圈位置闭环控制1）
- **位置+速度限制**：命令 0xA4（多圈位置闭环控制2）
- **力矩模式**：命令 0xA1（转矩闭环控制）
- **速度模式**：命令 0xA2（速度闭环控制）

---

## 下一步行动

1. **立即开始**：阶段二 - 早期被动模式
   - 研究标准步态数据
   - 实现髋踝联动关系
   - 实现标准步态轨迹生成

2. **准备材料**：
   - 收集标准步态数据（髋关节、踝关节角度曲线）
   - 确定步态周期参数（频率、相位等）

3. **测试计划**：
   - 先实现简单的髋踝联动（如线性关系）
   - 测试位置控制精度
   - 逐步完善步态轨迹

---

## 注意事项

1. **安全第一**：所有控制策略都要有安全限位和急停机制
2. **柔和控制**：避免刚性控制，确保运动柔和
3. **可调参数**：所有控制参数都要可调，便于调试和优化
4. **数据记录**：记录关键数据，用于分析和优化
5. **分阶段测试**：每个阶段都要充分测试，确保稳定可靠
