# 步态轨迹播放功能调试指南

## 功能概述

步态轨迹播放功能用于在被动模式下，按照预设的步态轨迹（髋关节和踝关节角度曲线）控制电机运动，实现对患者的柔和引导。

## 当前实现状态

✅ **已完成功能**：
- 默认测试轨迹（正弦波，髋关节±30度，踝关节±10度）
- 轨迹播放控制（启动/停止）
- 频率和速度可调
- 轨迹平滑处理（移动平均滤波）
- 线性插值算法

⚠️ **待完善功能**：
- 从上位机加载实际步态数据
- 髋踝联动关系优化

## 调试步骤

### 1. 准备工作

1. **使能电机**：
   ```
   e1    # 使能髋关节电机
   e2    # 使能踝关节电机
   ```

2. **检查当前角度**：
   ```
   r1    # 读取髋关节角度
   r2    # 读取踝关节角度
   ```

3. **（可选）移动到初始位置**：
   ```
   move1 0    # 髋关节移动到0度
   move2 0    # 踝关节移动到0度
   ```

### 2. 测试默认轨迹播放

**启动步态轨迹播放**：
```
gp <频率> <最大速度>
```

**参数说明**：
- `频率`：播放频率（Hz），范围 0-5 Hz
  - 1.0 Hz = 每秒1个步态周期（较慢，适合测试）
  - 0.5 Hz = 每2秒1个周期（很慢，适合观察）
  - 2.0 Hz = 每秒2个周期（较快）
- `最大速度`：最大角速度限制（dps），范围 0-1000 dps
  - 30 dps = 较慢，适合调试
  - 50 dps = 中等速度
  - 100 dps = 较快速度

**示例命令**：
```
gp 1.0 30    # 1.0 Hz频率，30 dps最大速度（推荐用于首次测试）
gp 0.5 20    # 0.5 Hz频率，20 dps最大速度（很慢，便于观察）
gp 2.0 50    # 2.0 Hz频率，50 dps最大速度（较快）
```

**停止播放**：
```
gps    # 停止步态轨迹播放
```

### 3. 观察和调试

**观察要点**：
1. **运动平滑性**：
   - 电机是否平滑移动，无"咔咔"声
   - 是否有明显的抖动或跳跃

2. **轨迹准确性**：
   - 髋关节是否在±30度范围内摆动
   - 踝关节是否在±10度范围内摆动
   - 两个关节是否按预期相位关系运动

3. **速度控制**：
   - 运动速度是否在设定范围内
   - 是否过快或过慢

4. **同步性**：
   - 髋关节和踝关节是否同步运动
   - 相位关系是否正确（默认轨迹中踝关节相位偏移90度）

**调试技巧**：
- 先用较低频率（0.5-1.0 Hz）和较低速度（20-30 dps）测试
- 观察一个完整周期后，再逐步提高频率和速度
- 如果运动不平滑，可以降低速度限制
- 如果轨迹不准确，检查电机使能状态和当前角度

### 4. 常见问题排查

**问题1：电机不动**
- 检查电机是否已使能（`e1`, `e2`）
- 检查CAN通信是否正常（发送`r1`或`r2`看是否有返回）
- 检查轨迹是否已加载（启动时会提示"Gait trajectory not loaded!"）

**问题2：运动不平滑，有"咔咔"声**
- 降低速度限制（如从50改为30 dps）
- 检查电机是否处于正确模式（位置控制模式）
- 检查是否有机械阻力

**问题3：轨迹不准确**
- 检查当前角度是否在合理范围内
- 检查电机编码器是否正常（`r1`, `r2`）
- 检查单位换算是否正确（关节角度 vs 电机轴角度）

**问题4：两个关节不同步**
- 检查两个电机是否都已使能
- 检查CAN总线通信是否正常
- 检查轨迹数据是否正确

### 5. 性能参数调整

如果需要调整性能参数，可以修改 `firmware/src/main.cpp` 中的以下参数：

**轨迹更新频率**（`updateIntervalMs`）：
```cpp
GaitPlaybackState gaitPlayback = {false, 1.0f, 2.0f, 0, 0, 10, 0.0f, 100.0f};
//                                                                    ^^
//                                                              更新间隔（毫秒）
```
- 默认：10ms（100 Hz更新频率）
- 更平滑：5ms（200 Hz）
- 更省资源：20ms（50 Hz）

**平滑滤波窗口大小**（`SMOOTH_FILTER_SIZE`）：
```cpp
#define SMOOTH_FILTER_SIZE 5
```
- 默认：5点移动平均
- 更平滑：10点（但会有延迟）
- 更快速响应：3点（但可能不够平滑）

## 下一步开发计划

### 1. 加载实际步态数据
- 从上位机（Python GUI）加载采集的步态周期数据
- 通过串口传输轨迹数据到下位机
- 替换默认的正弦波轨迹

### 2. 髋踝联动优化
- 根据实际步态数据建立髋踝联动关系
- 实现更精确的联动控制逻辑

### 3. 位置控制优化
- 添加加速度限制
- 实现阻力检测和柔性响应
- 优化位置控制精度

## 测试记录模板

```
测试日期：____年____月____日
测试人员：___________

测试参数：
- 频率：____ Hz
- 最大速度：____ dps
- 电机使能状态：髋关节 [ ] 踝关节 [ ]

测试结果：
- 运动平滑性：[ ] 优秀 [ ] 良好 [ ] 一般 [ ] 差
- 轨迹准确性：[ ] 优秀 [ ] 良好 [ ] 一般 [ ] 差
- 速度控制：[ ] 优秀 [ ] 良好 [ ] 一般 [ ] 差
- 同步性：[ ] 优秀 [ ] 良好 [ ] 一般 [ ] 差

问题记录：
_________________________________________________
_________________________________________________

改进建议：
_________________________________________________
_________________________________________________
```
