## 规范整理：电机 CAN 协议与髋踝联动

> 本文档用于把 PDF 中的 **关键条目** 固化下来，作为后续写控制程序的唯一“真值来源”之一。建议：每确认一条，就立刻写进来，并标注 **来源文档 + 页码**。

---

### 1. 电机 CAN 协议（来自：电机CAN协议说明 V2.35.pdf）

> 下面先留出结构，等你（或我根据你提供的信息）把具体内容逐条填进去。

- **1.1 基本 CAN 参数**
  - 波特率：1M
  - 数据帧类型：标准帧 / 扩展帧：标准帧
  - ID 分配规则（如：每个电机一个 ID 段 / 指令与反馈分开等）：
    髋关节电机 (ID 1)**：比例为 **1° = 3600 单位**。
    踝关节电机 (ID 2)**：比例为 **1° = 1000 单位**。
  - 心跳或周期性状态帧（ID / 周期 / 含义）：

- **1.2 指令帧格式**（来源：电机CAN总线通讯协议 V2.35）
  - 通用格式：
    - ID 结构：控制指令 ID = 0x140 + 电机ID（1=髋，2=踝）
      - 髋关节：0x141
      - 踝关节：0x142
    - DLC（数据长度）：8 字节
    - 帧格式：数据帧，标准帧
    - 数据格式（小端序）：
      - 字节0：命令字节
      - 字节1-7：命令数据（根据命令类型不同）
  - 关键命令（来源：协议文档 V2.35）：
    - 0x80：电机关闭命令（掉电）
    - 0x81：电机停止命令
    - 0x88：电机运行命令（使能）
    - 0x92：读取多圈角度命令
    - 0x9A：读取电机状态1和错误标志
    - 0x9B：清除电机错误标志
    - 0x9C：读取电机状态2（温度、电流、速度、编码器位置）
    - 0xA3：多圈位置闭环控制命令1（位置控制）
    - 0xA4：多圈位置闭环控制命令2（位置控制+速度限制）

- **1.3 反馈帧格式**（来源：电机CAN总线通讯协议 V2.35）
  - 电机状态帧：
    - ID：与控制指令相同（0x140 + 电机ID），电机在收到命令后 0.25ms 内回复
      - 髋关节反馈：0x141
      - 踝关节反馈：0x142
    - 多圈角度回复（命令 0x92）：
      - 格式：int64_t，DATA[1-7]（7字节，小端序）
      - 单位：0.01°/LSB（协议单位）
      - 注意：用户文档中记录的比例（髋：1°=3600单位，踝：1°=1000单位）可能是编码器单位，而非协议单位
    - 位置控制回复（命令 0xA3/0xA4）：
      - DATA[0]：命令字节（0xA3 或 0xA4）
      - DATA[1]：电机温度（int8_t，1℃/LSB）
      - DATA[2-3]：转矩电流/功率（int16_t，小端序）
      - DATA[4-5]：电机速度（int16_t，小端序，1dps/LSB）
      - DATA[6-7]：编码器位置（uint16_t，小端序）
    - 状态1回复（命令 0x9A）：
      - DATA[0]：命令字节（0x9A）
      - DATA[1]：电机温度（int8_t，1℃/LSB）
      - DATA[2-3]：母线电压（uint16_t，小端序，0.01V/LSB）
      - DATA[4-5]：母线电流（uint16_t，小端序，0.01A/LSB）
      - DATA[6]：电机状态（uint8_t，0x00=开启，0x10=关闭）
      - DATA[7]：错误状态（uint8_t，bit0=电压状态，bit3=温度状态）

- **1.4 时序与安全要求**
  - 上电顺序、初始化流程：
  - 发送指令的最大频率 / 最小间隔：
  - 必须遵守的流程（例如：先清故障 → 使能 → 模式设置 → 下发目标）：

> 建议：每条协议说明都尽量“可直接写成代码注释”，例如：
> 「编码器位置为 int32，单位 0.01°，0 对应机械零位，范围 -18000 ~ +18000」

---

### 2. 髋踝联动调试方案（来自：髋踝联动调试方案.pdf）

- **2.1 关节定义与坐标方向**
  - 髋关节正方向约定：
  - 踝关节正方向约定：
  - 零位姿态（站立时各关节角度）：

- **2.2 联动关系（数学或表格形式）**
  - 示例结构（具体数字待从文档中提取）：
    - 踝角度 = f(髋角度)：
    - 步态周期内各相位的角度参考表：

- **2.3 调试流程与注意事项**
  - 初次上电 / 首次联动前的检查清单：
  - 推荐的测试顺序（先单关节，后联动；先小角度，后大幅度等）：
  - 安全限位、急停、异常停机的处理：

---

### 3. 待确认 / 待补充问题列表

> 当你在读 PDF 或现场调试时有任何“不确定”的地方，可以先记在这里，后续再逐条确认。

- [ ] 例：电机故障码 0xXX 在文档中含义是否唯一？是否有组合故障？
- [ ] 例：髋踝联动中是否考虑步态频率变化对角度曲线的影响？

